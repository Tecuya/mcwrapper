#! /bin/bash

# path to the minecraft_server.jar
MINECRAFT_SERVER_PATH="/usr/local/minecraft/minecraft_server.jar"

# Java VM settings
MX_SIZE="1024M"
MS_SIZE="1024M"

# command for starting minecraft_server.jar
MINECRAFT_SERVER_CMD="java -Xmx${MX_SIZE} -Xms${MS_SIZE} -jar $MINECRAFT_SERVER_PATH nogui"

PID_FILE="mcwrapper.pid"

# END CONFIGURATION SETTINGS ############
#########################################

COMMAND_PIPE="command_input"

function read_command {
	# read from the command pipe
	exec < $COMMAND_PIPE
	
	read INPUT
	echo $INPUT
	
	# if the user said "stop" then exit after the command completes.
	if [[ "$INPUT" = "stop" ]]; then
		exit 0
	fi
	
	# recurse
	read_command
}

function send_command {
	check_is_running
	
	COMMAND=$1
	echo $COMMAND > $COMMAND_PIPE
}

function check_is_running {
	if [[ ! -e $PID_FILE ]]; then
		#echo "Server not running!" >&2
		return 1 # TODO: set up some real exit codes that are unique
	fi
	
	PID=`cat $PID_FILE`
	
	# check to see if we have a wrapper currently running
	kill -0 $PID 2>&- 1>&-
	if [[ $? != 0 ]]; then
		#echo "Server not running!" >&2
		return 1 # TODO: set up some real exit codes that are unique
	fi
	
	return 0
}

function set_up_pipe {
	if [[ ! -p "$COMMAND_PIPE" ]]; then
		echo "Pipe doesn't exist, creating it..." >&2
		mkfifo $COMMAND_PIPE
		
		if [[ $? != 0 ]]; then
			# if mkfifo failed, print error message, exit non-zero.
			echo "Error creating the pipe ($?)." >&2
			exit 1
		fi
	fi
}

function print_usage {
	echo "USAGE:"
	echo "    $0 <action>"
	echo "Action can be one of:"
	echo "    start  -- start the server if it's not already running"
	echo "    status -- whether the server is running or not"
	echo "Any other action is interpretted as a server command and is directed to the minecraft server"
	echo ""
}

## begin meat of program:

if [[ $# -eq 0 ]]; then
	print_usage
	exit 0
fi

ACTION=$@

# must cd to minecraft server directory to make sure support files are created in the correct place.
cd `dirname $MINECRAFT_SERVER_PATH`

case $ACTION in
	start )
		# write the PID file and start'er up!
		# don't start if we're already running.
		
		check_is_running
		
		if [[ $? = 0 ]]; then
			echo "Server is already running. Exiting..." >&2
			exit 1
		fi
		
		echo $$ > $PID_FILE
		set_up_pipe
		read_command | $MINECRAFT_SERVER_CMD
		
		# clean up PID file when done.
		rm $PID_FILE
		;;
	status )
		check_is_running
		if [[ $? = 0 ]]; then
			echo "Server is running." >&2
			exit 0
		fi
		
		echo "Server is NOT running." >&2
		exit 1
		
		;;
	* )
		echo "sending: $ACTION"
		send_command "$ACTION"
		exit 0
		;;
esac

exit 0


